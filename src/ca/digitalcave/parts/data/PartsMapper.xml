<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ca.digitalcave.parts.data.PartsMapper">
	<resultMap type="ca.digitalcave.parts.model.Category" id="heirarchy">
		<result property="id" column="category_id"/>
		<result property="name" column="category_name"/>
		<collection property="families" javaType="list" ofType="ca.digitalcave.parts.model.Family">
			<id property="id" column="family_id"/>
			<result property="name" column="family_name"/>
		</collection>
	</resultMap>

	<select id="selectHeirarchy" resultMap="heirarchy">
select distinct c.category_id, c.name category_name, f.family_id, f.name family_name
from category c
inner join family f on f.category_id = c.category_id
inner join part p on p.family_id = f.family_id
inner join attribute a on a.part_id = p.part_id 
		<where>
			<if test="terms.size() gt 0">
and (
				<foreach collection="terms" item="term" separator=" or ">
(lower(a.name) like '%${term}%' or lower(a.val) like '%${term}%' or lower(p.part_no) like '%${term}%')
				</foreach>
)
			</if>
		</where>
order by c.name, f.name
	</select>
	
	<select id="selectParts" resultType="ca.digitalcave.parts.model.Part">
select distinct p.part_id as id, p.part_no, p.description, p.notes, p.available, p.minimum
from family f
inner join part p on f.family_id = p.family_id
inner join attribute a on p.part_id = a.part_id
		<where>
			<if test="category != null">
f.category_id = #{category}
			</if>
			<if test="family != null">
f.family_id = #{family}
			</if>
			<if test="terms.size() gt 0">
and (
				<foreach collection="terms" item="term" separator=" or ">
(lower(a.name) like '%${term}%' or lower(a.val) like '%${term}%' or lower(p.part_no) like '%${term}%')
				</foreach>
)
			</if>
		</where>
order by p.part_no
	</select>
		
	<select id="selectCategory" resultType="ca.digitalcave.parts.model.Category">
select category_id as id, name
from category
where name = #{name} and account_id = #{account.id}
	</select>
	<insert id="insertCategory">
		<selectKey order="BEFORE" resultType="int" keyProperty="category.id">
select coalesce(max(category_id),0) + 1 from category
		</selectKey>
insert into category (category_id, account_id, name, created_at, modified_at)
values (#{category.id}, #{category.account.id}, #{category.name}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
	</insert>
	<update id="updateCategory">
update category set name = #{category.name}, modified_at = CURRENT_TIMESTAMP
where category_id = #{category.id}
	</update>
	<delete id="deleteCategory">
delete category
where category_id = #{id}
	</delete>
	
	<select id="selectFamily" resultType="ca.digitalcave.parts.model.Family">
select family_id as id, name
from family where name = #{name} and category_id = #{category.id}
	</select>
	<insert id="insertFamily">
		<selectKey order="BEFORE" resultType="int" keyProperty="family.id">
select coalesce(max(family_id),0) + 1 from family
		</selectKey>
insert into family (family_id, category_id, name, created_at, modified_at)
values (#{family.id}, #{family.category.id}, #{category.name}, CURRENT_TIMESTAMP, CURRENT_TIMESTAMP)
	</insert>
	<update id="updateFamily">
update family set name = #{family.name}, modified_at = CURRENT_TIMESTAMP
where family_id = #{family.id}
	</update>
	<delete id="deleteFamily">
delete family
where family_id = #{id}
	</delete>

	<insert id="insertPart">
		<selectKey order="BEFORE" keyProperty="id">
select coalesce(max(part_id),0) + 1 from part
		</selectKey>
insert into part (part_id, family_id, available, minimum, part_no, description, notes)
values (#{part.id}, #{part.family.id}, #{part.available}, #{part.minimum}, #{part.number}, #{part.description}, #{part.description}));
	</insert>
	<update id="updatePart">
update part
		<set>
			<if test="part.family != null">family_id = #{part.family.id},</if>
			<if test="part.available != null">available = #{part.available},</if>
			<if test="part.minimum != null">minimum = #{part.minimum},</if>
			<if test="part.number != null">part_no = #{part.number},</if>
			<if test="part.description != null">description = #{part.description},</if>
			<if test="part.notes != null">notes = #{parts.notes},</if>
		</set>
where part_id = #{part.id}
	</update>
	<delete id="deletePart">
delete part
where part_id = #{id}
	</delete>
	
	<select id="selectAttributes" resultType="ca.digitalcave.parts.model.Attribute">
select name, value, href, sort
from attribute
where part_id = ${part}
order by sort, name
	</select>
	<insert id="insertAttribute">
insert into attribute (part_id, name, value, href, sort)
values (#{attribute.part.id}, #{attribute.name}, #{attribute.value}, #{attribute.href,jdbcType=VARCHAR}, #{attribute.sort})
	</insert>
	<update id="updateAttribute">
update attribute
		<set>
			<if test="attribute.name != null">name = #{attribute.name},</if>
			<if test="attribute.value != null">value = #{attribute.value},</if>
			<if test="attribute.href != null">href = #{attribute.href},</if>
			<if test="attribute.sort != null">sort = #{attribute.sort},</if>
		</set>
where attribute_id = #{attribute.id}
	</update>
	<delete id="deleteAttrtibute">
delete from attribute
where attribute_id = #{id}
	</delete>
	
	<select id="selectAccount" resultType="ca.digitalcave.parts.model.Account">
select account_id as id, email, secret, created_at as createdAt, modified_at as modifiedAt
from account
where identifier = #{identifier}
	</select>

</mapper>