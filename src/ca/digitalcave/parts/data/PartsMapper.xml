<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="ca.digitalcave.parts.data.PartsMapper">
	<resultMap type="ca.digitalcave.parts.model.Category" id="category">
		<result property="id" column="category_id"/>
		<result property="name" column="category_name"/>
		<collection property="families" javaType="list" ofType="ca.digitalcave.parts.model.Family">
			<id property="categoryId" column="category_id"/>
			<id property="familyId" column="family_id"/>
			<result property="name" column="family_name"/>
			<collection property="parts" javaType="list" ofType="ca.digitalcave.parts.model.Part">
				<id property="id" column="part_id"/>
			</collection>
		</collection>
	</resultMap>

	<select id="search" resultMap="category">
select distinct p.part_id, p.part_no, p.description, f.family_id, f.name family_name, c.category_id, c.name category_name 
from category c 
inner join family f on c.category_id = f.category_id
inner join part p on f.family_id = p.family_id
inner join attribute a on p.part_id = a.part_id
		<where>
			<if test="terms.size() gt 0">
				<foreach collection="terms" item="term" separator=" or ">
lower(a.val) like '%${term}%' or lower(a.name) like '%${term}%'
				</foreach>
			</if>
		</where>
order by c.name, f.name
	</select>
	
	<select id="attributesByPart" resultType="ca.digitalcave.parts.model.Attribute">
select name, value, href
from attribute
where part_id = ${partId}
order by sort, name
	</select>
	
	<resultMap id="partsByFamily" type="ca.digitalcave.parts.model.Part">
		<id property="id" column="part_id"/>
		<collection property="attributes" javaType="list" ofType="ca.digitalcave.parts.model.Attribute">
			<result property="name" column="name"/>
			<result property="value" column="value"/>
			<result property="href" column="href"/>
		</collection>
	</resultMap>
	
	<select id="partsByFamily" resultMap="partsByFamily">
select a.part_id, a.name, a.value, a.href
from attribute a
inner join attribute f on a.part_id = f.part_id and f.name = 'Family' <if test="family != null">and f.value = #{family}</if>
inner join attribute c on a.part_id = c.part_id and c.name = 'Category' <if test="category != null">and c.value = #{category}</if>
inner join attribute p on a.part_id = p.part_id and p.name = 'Manufacturer Part Number'
order by c.name, f.name, p.value
	</select>
	
	<select id="newPartId" resultType="short">
select coalesce(max(part_id),0) + 1 from attribute
	</select>
	
	<insert id="insert">
insert into attribute (part_id, name, value, href, sort)
values (#{attribute.partId}, #{attribute.name}, #{attribute.value}, #{attribute.href,jdbcType=VARCHAR}, #{attribute.sort})
	</insert>
	
	<delete id="remove">
delete from attribute
where part_id = #{partId}
	</delete>
	
	<update id="setQuantity">
update attribute set value = #{value} where part_id = #{partId} and name = 'Quantity In Stock'
	</update>
</mapper>